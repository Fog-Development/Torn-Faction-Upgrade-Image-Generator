<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Torn Faction Upgrades Generator</title>
    
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://nuke.family/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://nuke.family/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://nuke.family/img/favicon-16x16.png">
    
    <!-- Open Graph / Discord -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://perks.nuke.family">
    <meta property="og:title" content="Torn Faction Upgrades Generator">
    <meta property="og:description" content="Create beautiful faction upgrade images from your Torn API data. Generate custom PNG images of your faction's peace branch upgrades with customizable colors and layouts.">
    <meta property="og:image" content="https://perks.nuke.family/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://perks.nuke.family">
    <meta name="twitter:title" content="Torn Faction Upgrades Generator">
    <meta name="twitter:description" content="Create beautiful faction upgrade images from your Torn API data. Generate custom PNG images of your faction's peace branch upgrades with customizable colors and layouts.">
    <meta name="twitter:image" content="https://perks.nuke.family/og-image.png">
    
    <!-- Additional meta -->
    <meta name="description" content="Create beautiful faction upgrade images from your Torn API data. Generate custom PNG images of your faction's peace branch upgrades with customizable colors and layouts.">
    <meta name="author" content="Fogest">
    <meta name="theme-color" content="#3b82f6">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --secondary: #10b981;
        --danger: #ef4444;
        --dark: #1f2937;
        --light: #f3f4f6;
        --border: #e5e7eb;
        --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        width: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        animation: slideUp 0.5s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        padding: 30px;
      }

      .form-group {
        margin-bottom: 25px;
        animation: fadeIn 0.6s ease-out forwards;
        opacity: 0;
      }

      .form-group:nth-child(1) {
        animation-delay: 0.1s;
      }
      .form-group:nth-child(2) {
        animation-delay: 0.2s;
      }
      .form-group:nth-child(3) {
        animation-delay: 0.3s;
      }
      .form-group:nth-child(4) {
        animation-delay: 0.4s;
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark);
        font-size: 14px;
      }

      .input-wrapper {
        position: relative;
      }

      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      input[type="text"]:focus,
      input[type="password"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .color-inputs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .color-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      input[type="color"] {
        width: 50px;
        height: 50px;
        border: 2px solid var(--border);
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      input[type="color"]:hover {
        transform: scale(1.05);
      }

      .color-label {
        flex: 1;
      }

      .info-box {
        background: #fef3c7;
        border: 2px solid #fbbf24;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .info-icon {
        font-size: 24px;
      }

      .info-text {
        font-size: 13px;
        color: #92400e;
        line-height: 1.5;
      }

      .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        width: 100%;
        justify-content: center;
        margin-top: 10px;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
      }

      .btn-primary:active {
        transform: translateY(0);
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-download {
        background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
        color: white;
        margin-top: 20px;
      }

      .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
      }

      .error-message {
        background: #fee2e2;
        border: 2px solid #fca5a5;
        color: #991b1b;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        display: none;
        animation: shake 0.5s ease;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .success-message {
        background: #d1fae5;
        border: 2px solid #6ee7b7;
        color: #065f46;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        display: none;
      }

      .preview-section {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 2px solid var(--border);
        display: none;
        animation: slideUp 0.5s ease-out;
      }

      .preview-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 20px;
        text-align: center;
      }

      .canvas-container {
        background: var(--light);
        border-radius: 10px;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 200px;
        position: relative;
        overflow: auto;
        max-height: 600px;
      }

      #previewCanvas {
        border-radius: 8px;
        box-shadow: var(--shadow);
        max-width: 100%;
        height: auto;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .checkbox-label {
        font-size: 14px;
        color: var(--dark);
        cursor: pointer;
        user-select: none;
      }

      .footer {
        margin-top: 20px;
        text-align: center;
        color: white;
        font-size: 14px;
        opacity: 0.9;
      }

      .footer a {
        color: white;
        text-decoration: none;
        font-weight: 600;
        transition: opacity 0.3s ease;
      }

      .footer a:hover {
        opacity: 0.7;
        text-decoration: underline;
      }

      @media (max-width: 600px) {
        .container {
          border-radius: 15px;
        }

        .header {
          padding: 25px 20px;
        }

        .header h1 {
          font-size: 24px;
        }

        .content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🎮 Torn Faction Upgrades Generator</h1>
        <p>Create beautiful faction upgrade images from your Torn API data</p>
      </div>

      <div class="content">
        <div class="info-box">
          <span class="info-icon">ℹ️</span>
          <div class="info-text">
            <strong>API Key Required:</strong> Your Torn API key needs at least
            "Minimal" access level to fetch faction upgrades.
          </div>
        </div>

        <div class="form-group">
          <label for="apiKey">Torn API Key</label>
          <div class="input-wrapper">
            <input
              type="password"
              id="apiKey"
              placeholder="Enter your Torn API key"
            />
          </div>
        </div>

        <div class="form-group">
          <label>Colors</label>
          <div class="color-inputs">
            <div class="color-input-group">
              <input type="color" id="bgColor" value="#1e1e1e" />
              <div class="color-label">
                <label for="bgColor">Background</label>
              </div>
            </div>
            <div class="color-input-group">
              <input type="color" id="headerColor" value="#ffd700" />
              <div class="color-label">
                <label for="headerColor">Headers</label>
              </div>
            </div>
            <div class="color-input-group">
              <input type="color" id="textColor" value="#ffffff" />
              <div class="color-label">
                <label for="textColor">Text</label>
              </div>
            </div>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="transparentBg" />
            <label for="transparentBg" class="checkbox-label"
              >Transparent Background</label
            >
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="centerContent" />
            <label for="centerContent" class="checkbox-label"
              >Center Content</label
            >
          </div>
        </div>

        <button class="btn btn-primary" id="generateBtn">
          <span>🎨</span>
          <span>Generate Image</span>
        </button>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Fetching faction data...</p>
        </div>

        <div class="preview-section" id="previewSection">
          <h2 class="preview-title">Preview</h2>
          <div class="canvas-container">
            <canvas id="previewCanvas"></canvas>
          </div>
          <button class="btn btn-download" id="downloadBtn">
            <span>⬇️</span>
            <span>Download PNG</span>
          </button>
        </div>
      </div>
    </div>

    <div class="footer">
      Made by
      <a
        href="https://www.torn.com/profiles.php?XID=2254826"
        target="_blank"
        rel="noopener noreferrer"
        >Fogest [2254826]</a
      >
    </div>

    <script>
      // Store user preferences
      const storage = {
        get: (key) => {
          try {
            return JSON.parse(localStorage.getItem(key));
          } catch {
            return localStorage.getItem(key);
          }
        },
        set: (key, value) => {
          localStorage.setItem(
            key,
            typeof value === "object" ? JSON.stringify(value) : value
          );
        },
      };

      // Load saved preferences
      document.addEventListener("DOMContentLoaded", () => {
        const savedApiKey = storage.get("apiKey");
        const savedBgColor = storage.get("bgColor");
        const savedHeaderColor = storage.get("headerColor");
        const savedTextColor = storage.get("textColor");
        const savedTransparent = storage.get("transparentBg");
        const savedCenterContent = storage.get("centerContent");

        if (savedApiKey) document.getElementById("apiKey").value = savedApiKey;
        if (savedBgColor)
          document.getElementById("bgColor").value = savedBgColor;
        if (savedHeaderColor)
          document.getElementById("headerColor").value = savedHeaderColor;
        if (savedTextColor)
          document.getElementById("textColor").value = savedTextColor;
        if (savedTransparent !== null)
          document.getElementById("transparentBg").checked = savedTransparent;
        if (savedCenterContent !== null)
          document.getElementById("centerContent").checked = savedCenterContent;
      });

      // Save preferences on change
      document
        .getElementById("apiKey")
        .addEventListener("change", (e) =>
          storage.set("apiKey", e.target.value)
        );
      document
        .getElementById("bgColor")
        .addEventListener("change", (e) =>
          storage.set("bgColor", e.target.value)
        );
      document
        .getElementById("headerColor")
        .addEventListener("change", (e) =>
          storage.set("headerColor", e.target.value)
        );
      document
        .getElementById("textColor")
        .addEventListener("change", (e) =>
          storage.set("textColor", e.target.value)
        );
      document
        .getElementById("transparentBg")
        .addEventListener("change", (e) =>
          storage.set("transparentBg", e.target.checked)
        );
      document
        .getElementById("centerContent")
        .addEventListener("change", (e) =>
          storage.set("centerContent", e.target.checked)
        );

      // Main generation function
      document
        .getElementById("generateBtn")
        .addEventListener("click", async () => {
          const apiKey = document.getElementById("apiKey").value.trim();

          if (!apiKey) {
            showError("Please enter your Torn API key");
            return;
          }

          showLoading(true);
          hideMessages();

          try {
            // Fetch faction data from Torn API
            const response = await fetch(
              "https://api.torn.com/v2/faction/upgrades",
              {
                headers: {
                  Accept: "application/json",
                  Authorization: `ApiKey ${apiKey}`,
                },
              }
            );

            if (!response.ok) {
              throw new Error(
                `API Error: ${response.status} - ${response.statusText}`
              );
            }

            const data = await response.json();

            if (!data.upgrades || !data.upgrades.peace) {
              throw new Error(
                "Invalid API response: Missing faction upgrades data"
              );
            }

            // Generate the image
            generateImage(data.upgrades.peace);
            showSuccess("Image generated successfully!");
          } catch (error) {
            console.error("Error:", error);
            showError(
              error.message ||
                "Failed to fetch faction data. Please check your API key and try again."
            );
          } finally {
            showLoading(false);
          }
        });

      function generateImage(peaceUpgrades) {
        const canvas = document.getElementById("previewCanvas");
        const ctx = canvas.getContext("2d");

        const bgColor = document.getElementById("bgColor").value;
        const headerColor = document.getElementById("headerColor").value;
        const textColor = document.getElementById("textColor").value;
        const transparentBg = document.getElementById("transparentBg").checked;
        const centerContent = document.getElementById("centerContent").checked;

        // Sort categories by order field
        const sortedCategories = [...peaceUpgrades].sort(
          (a, b) => a.order - b.order
        );

        // Canvas settings
        const width = 400;
        const padding = 30;
        const lineHeight = 22;
        const headerSize = 24;
        const textSize = 14;
        const categorySpacing = 18;
        const upgradeSpacing = 8;

        // Calculate total height needed
        let totalHeight = padding;
        sortedCategories.forEach((category) => {
          if (category.upgrades && category.upgrades.length > 0) {
            totalHeight += headerSize + 6; // Category header

            // Calculate height for each upgrade with word wrapping
            category.upgrades.forEach((upgrade) => {
              totalHeight += lineHeight; // Name line

              // Calculate wrapped lines for ability text
              ctx.font = `${
                textSize - 1
              }px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
              const words = upgrade.ability.split(" ");
              let line = "";
              let lines = 0;
              const maxWidth = width - padding * 2;

              for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + " ";
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;

                if (testWidth > maxWidth && n > 0) {
                  lines++;
                  line = words[n] + " ";
                } else {
                  line = testLine;
                }
              }
              lines++; // Add the last line
              totalHeight += lines * lineHeight + upgradeSpacing;
            });

            totalHeight += categorySpacing;
          }
        });

        canvas.width = width;
        canvas.height = totalHeight;

        // Clear canvas
        ctx.clearRect(0, 0, width, totalHeight);

        // Background
        if (!transparentBg) {
          ctx.fillStyle = bgColor;
          ctx.fillRect(0, 0, width, totalHeight);
        }

        // Start drawing
        let currentY = padding;

        sortedCategories.forEach((category, categoryIndex) => {
          // Skip categories with no upgrades
          if (!category.upgrades || category.upgrades.length === 0) {
            return;
          }

          // Draw category header
          ctx.font = `bold ${headerSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
          ctx.fillStyle = headerColor;
          const headerX = centerContent ? width / 2 : padding;
          ctx.textAlign = centerContent ? "center" : "left";
          ctx.fillText(category.name, headerX, currentY);
          currentY += headerSize + 6;

          // Draw upgrades
          ctx.font = `${textSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;

          category.upgrades.forEach((upgrade, index) => {
            // Upgrade name
            ctx.fillStyle = headerColor;
            ctx.font = `bold ${textSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
            const nameX = centerContent ? width / 2 : padding;
            ctx.textAlign = centerContent ? "center" : "left";
            ctx.fillText(upgrade.name, nameX, currentY);
            currentY += lineHeight;

            // Upgrade ability
            ctx.fillStyle = textColor;
            ctx.font = `${
              textSize - 1
            }px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;

            // Word wrap for long descriptions
            const words = upgrade.ability.split(" ");
            let line = "";
            const maxWidth = width - padding * 2;

            for (let n = 0; n < words.length; n++) {
              const testLine = line + words[n] + " ";
              const metrics = ctx.measureText(testLine);
              const testWidth = metrics.width;

              if (testWidth > maxWidth && n > 0) {
                const abilityX = centerContent ? width / 2 : padding;
                ctx.textAlign = centerContent ? "center" : "left";
                ctx.fillText(line, abilityX, currentY);
                line = words[n] + " ";
                currentY += lineHeight;
              } else {
                line = testLine;
              }
            }
            const abilityX = centerContent ? width / 2 : padding;
            ctx.textAlign = centerContent ? "center" : "left";
            ctx.fillText(line, abilityX, currentY);
            currentY += lineHeight + upgradeSpacing;
          });

          currentY += categorySpacing;
        });

        // Show preview section
        document.getElementById("previewSection").style.display = "block";
        document
          .getElementById("previewSection")
          .scrollIntoView({ behavior: "smooth", block: "center" });
      }

      // Download function
      document.getElementById("downloadBtn").addEventListener("click", () => {
        const canvas = document.getElementById("previewCanvas");
        const link = document.createElement("a");
        link.download = `faction-upgrades-${Date.now()}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      });

      // Helper functions
      function showError(message) {
        const errorEl = document.getElementById("errorMessage");
        errorEl.textContent = message;
        errorEl.style.display = "block";
      }

      function showSuccess(message) {
        const successEl = document.getElementById("successMessage");
        successEl.textContent = message;
        successEl.style.display = "block";
      }

      function hideMessages() {
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("successMessage").style.display = "none";
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
        document.getElementById("generateBtn").disabled = show;
      }
    </script>
  </body>
</html>
